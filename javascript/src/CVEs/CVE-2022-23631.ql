/**
 * @name Use of unsafe superjson parse or deserialize functions
 * @description Specific versions of the superjson library are vulnerable to prototype pollution. Avoid calling
 *              their parse() or deserialize() functions.
 * @kind problem
 * @problem.severity error
 * @security-severity 10.0
 * @precision high
 * @id githubsecuritylab/cve-2022-23631
 * @tags security
 *       external/cwe/cwe-094
 *       external/cve/cve-2022-23631
 */

import javascript
import semmle.javascript.dependencies.Dependencies
import semmle.javascript.dependencies.SemVer

class SuperJsonCalls extends DataFlow::CallNode {
  SuperJsonCalls() {
    // https://github.com/blitz-js/superjson/security/advisories/GHSA-5888-ffcr-r425
    // https://github.com/blitz-js/superjson/commit/0d68cd51a430999b848f6da7af528ee02560c883
    exists(NpmDependency dep |
      dep.getNpmPackageName() = "superjson" and
      dep.getVersion().(DependencySemVer).maybeBefore("1.8.1") and
      this = DataFlow::dependencyModuleImport(dep).getAMemberCall(["parse", "deserialize"])
    )
  }
}

from SuperJsonCalls calls
select calls, "Potential prototype pollution via superjson parse or deserialize functions!"
